---
title: "The `mvp` package: some timings"
author: "Robin K. S. Hankin"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
vignette: >
  %\VignetteIndexEntry{mvp_timings}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set-options, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", dev = "png", fig.width = 7, fig.height = 3.5, message = FALSE, warning = FALSE)
options(width = 80, tibble.width = Inf)
```

Here I present a short analysis of timings for benchmark tasks using
the `mvp` and `spray` packages.  I will show some timings using a
particularly favourable example that exploits the symbolic nature of
the `mvp` package.

```{r}
library("spray")
library("mpoly")
library("mvp")
library("microbenchmark")

`spray_to_mvp` <- function(L,symbols=letters){
  I <- L$index
  mvp(
      vars   = sapply(seq_len(nrow(I)),function(i){symbols[which(I[i,] != 0)]},simplify=FALSE),
      powers = sapply(seq_len(nrow(I)),function(i){          I[i,I[i,] != 0 ]},simplify=FALSE),
      coeffs = L$value
      )
}

`mvp_to_spray` <- function(S){
    cons <- constant(S)
    constant(S) <- 0
    vS <- vars(S)
    pS <- powers(S)
    av <- allvars(S)

    M <- matrix(0,length(powers(S)),length(av))
    for(i in seq_len(nrow(M))){
        v <- vS[[i]]
        p <- pS[[i]]

        M[i,sapply(v,function(x){which(x==av)})] <- p
    }

    if(cons==0){
      jj <- coeffs(S)
    } else {
      M <- rbind(M,0)
      jj <- c(elements(coeffs(S)),cons)
    }
    out <- list(M,jj)
    class(out) <- "spray"
    return(out)
}



n <- 30
k <- kahle(n, r = 3, p = 1:3, symbols = paste0("x", sprintf("%03d", 1:n)))
k
```

In the above, polynomial `k` has 300 terms of the form $xy^2z^3$.
Coercing `k` to `spray` form would need a $300\times 300$
matrix for the indices, almost every element of which would be zero.
This makes [the __spray__ package](https://github.com/RobinHankin/spray) slower:

```{r}
spray_k <- mvp_to_spray(k)
spray_k
microbenchmark(k^2, spray_k^2, times=10)
```

In the above, the first line uses `mvp` functionality, and the
second line uses `spray` functionality.  The speedup increases for
larger polynomials.

